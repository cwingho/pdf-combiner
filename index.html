<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Combiner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#F25F4C',
                    },
                    fontFamily: {
                        display: ['"Bricolage Grotesque"', 'sans-serif'],
                        mono: ['"DM Mono"', 'monospace'],
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-[#f2eee4] px-6 py-10 font-display text-[#0f1d2b] dark:bg-[#050608] dark:text-[#f2f1ed]">
    <div class="fixed inset-0 -z-10">
        <div class="absolute inset-0 opacity-80 bg-[radial-gradient(circle_at_1px_1px,_rgba(15,29,43,0.08)_1px,_transparent_0)] bg-[length:12px_12px] dark:bg-[radial-gradient(circle_at_1px_1px,_rgba(242,241,237,0.08)_1px,_transparent_0)]"></div>
        <div class="absolute inset-0 bg-[linear-gradient(120deg,rgba(242,95,76,0.08),transparent_60%)] dark:bg-[linear-gradient(120deg,rgba(242,95,76,0.15),transparent_65%)]"></div>
    </div>
    <main class="relative mx-auto max-w-5xl space-y-6">
        <nav class="flex flex-wrap items-center justify-between rounded-[24px] border border-black/10 bg-white/60 px-6 py-4 text-xs font-mono uppercase tracking-[0.3em] text-black/60 dark:border-white/10 dark:bg-white/5 dark:text-white/60">
            <span>PDF Atelier</span>
            <div class="mt-3 flex flex-wrap gap-3 sm:mt-0">
                <a data-nav="combine" href="index.html" class="nav-link inline-flex items-center justify-center rounded-full border border-black/15 bg-transparent px-4 py-2 text-[0.6rem] font-semibold tracking-[0.35em] text-black/70 transition-colors dark:border-white/20 dark:text-white/70">
                    Combine
                </a>
                <a data-nav="compress" href="pdf-compress.html" class="nav-link inline-flex items-center justify-center rounded-full border border-black/15 bg-transparent px-4 py-2 text-[0.6rem] font-semibold tracking-[0.35em] text-black/70 transition-colors dark:border-white/20 dark:text-white/70">
                    Compress
                </a>
            </div>
        </nav>
        <header class="space-y-3">
            <p class="text-[0.7rem] uppercase tracking-[0.3em] text-black/60 dark:text-white/60">DEVELOPED BY BC</p>
            <h1 class="text-4xl font-semibold leading-tight sm:text-5xl">PDF Combiner</h1>
            <p class="max-w-2xl text-base text-black/70 dark:text-white/70">Bind scattered pages without shipping data anywhere. Everything happens locally, then you carry the stitched folio away.</p>
        </header>

        <section class="rounded-[30px] border border-black/10 bg-[#f8f1e3] p-8 dark:border-white/10 dark:bg-[#111922]">
            <div id="dropZone" class="flex flex-col items-center justify-center rounded-[24px] border border-dashed border-black/20 bg-white/60 px-6 py-12 text-center dark:border-white/20 dark:bg-white/5">
                <span class="mb-6 flex h-16 w-16 items-center justify-center rounded-full border border-black/30 font-mono text-5xl leading-none dark:border-white/20">+</span>
                <p class="text-2xl font-medium">Drop PDFs or browse</p>
                <p class="mt-2 text-sm text-black/60 dark:text-white/60">Stack multiple documents, arrange them, then stitch.</p>
                <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
                <button id="selectFilesBtn" class="mt-6 inline-flex items-center justify-center rounded-full border border-transparent bg-primary px-6 py-3 text-xs font-semibold uppercase tracking-[0.3em] text-white">
                    Load PDFs
                </button>
            </div>
        </section>

        <section id="fileList" class="hidden rounded-[30px] border border-black/10 bg-[#fff9f2]/90 p-8 dark:border-white/10 dark:bg-[#0f1419]">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-mono uppercase tracking-[0.3em] text-black/50 dark:text-white/50">Queue</p>
                <h2 class="text-2xl font-semibold">Selected files</h2>
            </div>
            <p id="queueSummary" class="mt-3 hidden rounded-full border border-black/10 px-4 py-2 text-xs font-mono uppercase tracking-[0.25em] text-black/70 dark:border-white/15 dark:text-white/70"></p>
            <div id="selectedFiles" class="mt-6 space-y-4"></div>

            <div class="mt-6 flex flex-wrap gap-3">
                <button id="combineBtn" class="inline-flex items-center justify-center rounded-full border border-transparent bg-primary px-6 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-white disabled:opacity-40" disabled>
                    Merge
                </button>
                <button id="clearBtn" class="inline-flex items-center justify-center rounded-full border border-black/20 px-6 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-black/70 dark:border-white/20 dark:text-white/70">
                    Clear
                </button>
            </div>
        </section>

        <section id="progressContainer" class="hidden rounded-[30px] border border-black/10 bg-white/70 p-6 dark:border-white/10 dark:bg-white/5">
            <div class="h-1.5 w-full overflow-hidden rounded-full bg-black/10 dark:bg-white/20">
                <div id="progressBar" class="h-full w-0 bg-primary"></div>
            </div>
            <p id="progressText" class="mt-4 font-mono text-[0.65rem] uppercase tracking-[0.4em] text-black/60 dark:text-white/60">Processing: 0%</p>
        </section>

        <section id="resultContainer" class="hidden rounded-[30px] border border-black/10 bg-white/80 p-8 dark:border-white/15 dark:bg-[#0f1419]">
            <h2 class="text-2xl font-semibold">Combined PDF</h2>
            <div class="mt-4 space-y-4">
                <div id="pdfViewer" class="h-[520px] overflow-auto rounded-[30px] border border-black/10 bg-white/50 p-5 dark:border-white/15 dark:bg-white/5">
                    <div id="pdfCanvasContainer" class="flex flex-col items-center gap-6">
                        <p id="loadingText" class="flex items-center gap-2 font-mono text-sm uppercase tracking-[0.3em] text-black/60 dark:text-white/60">
                            <span class="text-lg">✚</span>
                            Waiting for pages
                        </p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3" id="shareButtons">
                    <a id="downloadBtn" href="#" class="inline-flex items-center justify-center rounded-full border border-transparent bg-primary px-6 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-white">
                        Download PDF
                    </a>
                    <button id="printBtn" class="inline-flex items-center justify-center rounded-full border border-black/20 px-6 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-black/70 dark:border-white/20 dark:text-white/70">
                        Open in new tab
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Detect dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize variables
        // Initialize PDF.js
const pdfjsLib = window.pdfjsLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        const PDFLib = window.PDFLib;

        const fileInput = document.getElementById('fileInput');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const fileList = document.getElementById('fileList');
        const selectedFiles = document.getElementById('selectedFiles');
        const combineBtn = document.getElementById('combineBtn');
        const clearBtn = document.getElementById('clearBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');

        let pdfFiles = [];
        let pdfOrder = [];
        let currentPdfUrl = null; // Store the URL of the combined PDF

        const navLinks = document.querySelectorAll('[data-nav]');
        const currentNav = window.location.pathname.includes('pdf-compress') ? 'compress' : 'combine';
        const navActiveClasses = ['bg-primary', 'text-white', 'border-transparent', 'dark:text-white'];
        const navInactiveClasses = ['bg-transparent', 'border-black/15', 'dark:border-white/20', 'text-black/70', 'dark:text-white/70'];

        navLinks.forEach(link => {
            const isActive = link.dataset.nav === currentNav;
            if (isActive) {
                navActiveClasses.forEach(cls => link.classList.add(cls));
                navInactiveClasses.forEach(cls => link.classList.remove(cls));
                link.setAttribute('aria-current', 'page');
            } else {
                navInactiveClasses.forEach(cls => link.classList.add(cls));
                navActiveClasses.forEach(cls => link.classList.remove(cls));
                link.removeAttribute('aria-current');
            }
        });

        // Event listeners
        selectFilesBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelection);
        clearBtn.addEventListener('click', clearFiles);
        combineBtn.addEventListener('click', combinePDFs);
        
        // Set up print and open tab buttons
        document.getElementById('printBtn').addEventListener('click', () => {
            if (currentPdfUrl) {
                window.open(currentPdfUrl, '_blank', 'noopener,noreferrer');
            }
        });

        // Handle file selection
        function handleFileSelection(e) {
            const newFiles = Array.from(e.target.files).filter(file => file.type === 'application/pdf');
            
            if (newFiles.length === 0) return;

            // Add new files to the list
            pdfFiles = [...pdfFiles, ...newFiles];
            pdfOrder = [...pdfOrder, ...newFiles.map((_, i) => pdfFiles.length - newFiles.length + i)];
            
            // Show file list
            fileList.classList.remove('hidden');
            
            // Update UI
            updateFileList();
        }

        // Update the file list UI
        function updateFileList() {
            selectedFiles.innerHTML = '';
            
            if (pdfFiles.length === 0) {
                fileList.classList.add('hidden');
                return;
            }
            
            pdfOrder.forEach((index, orderIndex) => {
                const file = pdfFiles[index];
                
                const fileItem = document.createElement('div');
                fileItem.className = 'flex flex-wrap items-center gap-4 rounded-[18px] border border-black/10 bg-white/70 px-4 py-3 text-sm dark:border-white/15 dark:bg-white/5';
                fileItem.innerHTML = `
                    <span class="flex h-10 w-10 items-center justify-center rounded-lg border border-black/15 bg-primary/15 text-primary dark:border-white/20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </span>
                    <div class="min-w-0 flex-1">
                        <p class="truncate font-medium">${file.name}</p>
                        <p class="text-xs text-black/60 dark:text-white/60">${formatFileSize(file.size)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="move-up-btn inline-flex h-9 w-9 items-center justify-center rounded-full border border-black/10 text-xs font-semibold uppercase tracking-[0.2em] text-black/60 disabled:opacity-30 dark:border-white/15 dark:text-white/60" ${orderIndex === 0 ? 'disabled' : ''} aria-label="Move up">↑</button>
                        <button class="move-down-btn inline-flex h-9 w-9 items-center justify-center rounded-full border border-black/10 text-xs font-semibold uppercase tracking-[0.2em] text-black/60 disabled:opacity-30 dark:border-white/15 dark:text-white/60" ${orderIndex === pdfOrder.length - 1 ? 'disabled' : ''} aria-label="Move down">↓</button>
                        <button class="remove-btn inline-flex h-9 w-9 items-center justify-center rounded-full border border-black/10 text-base font-semibold text-black/60 hover:text-primary dark:border-white/15 dark:text-white/60" aria-label="Remove file">×</button>
                    </div>
                `;
                
                const removeBtn = fileItem.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => removeFile(orderIndex));
                
                const moveUpBtn = fileItem.querySelector('.move-up-btn');
                if (orderIndex > 0) {
                    moveUpBtn.addEventListener('click', () => moveFile(orderIndex, orderIndex - 1));
                }
                
                const moveDownBtn = fileItem.querySelector('.move-down-btn');
                if (orderIndex < pdfOrder.length - 1) {
                    moveDownBtn.addEventListener('click', () => moveFile(orderIndex, orderIndex + 1));
                }
                
                selectedFiles.appendChild(fileItem);
            });
            
            // Enable/disable combine button
            combineBtn.disabled = pdfFiles.length < 2;
            updateQueueSummary();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Remove a file
        function removeFile(orderIndex) {
            const fileIndex = pdfOrder[orderIndex];
            pdfOrder = pdfOrder.filter((_, i) => i !== orderIndex);
            pdfFiles = pdfFiles.filter((_, i) => i !== fileIndex);
            
            // Update order indices to account for the removed file
            pdfOrder = pdfOrder.map(index => index > fileIndex ? index - 1 : index);
            
            updateFileList();
        }

        // Move a file in the order
        function moveFile(fromIndex, toIndex) {
            const temp = pdfOrder[fromIndex];
            pdfOrder[fromIndex] = pdfOrder[toIndex];
            pdfOrder[toIndex] = temp;
            updateFileList();
        }

        // Clear all files
        function clearFiles() {
            pdfFiles = [];
            pdfOrder = [];
            fileInput.value = '';
            fileList.classList.add('hidden');
            resultContainer.classList.add('hidden');
            updateFileList();
        }

        // Summarize queue state for quick glance
        function updateQueueSummary() {
            const summary = document.getElementById('queueSummary');
            if (!summary) return;
            
            if (pdfFiles.length === 0) {
                summary.classList.add('hidden');
                summary.textContent = '';
                return;
            }
            
            const totalBytes = pdfFiles.reduce((sum, file) => sum + file.size, 0);
            const label = pdfFiles.length === 1 ? 'file' : 'files';
            summary.textContent = `${pdfFiles.length} ${label} · ${formatFileSize(totalBytes)}`;
            summary.classList.remove('hidden');
        }

        // Combine PDFs
        async function combinePDFs() {
            try {
                // Show progress bar
                progressContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                
                // Create a new PDF document
                const mergedPdf = await PDFLib.PDFDocument.create();
                
                // Process each PDF file in order
                for (let i = 0; i < pdfOrder.length; i++) {
                    const fileIndex = pdfOrder[i];
                    const file = pdfFiles[fileIndex];
                    
                    // Update progress
                    const progress = Math.round((i / pdfOrder.length) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `Processing: ${progress}%`;
                    
                    // Read the file as ArrayBuffer
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    
                    // Load the PDF
                    const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    // Copy all pages
                    const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    
                    // Add pages to the new document
                    pages.forEach((page) => {
                        mergedPdf.addPage(page);
                    });
                }
                
                // Complete progress
                progressBar.style.width = '100%';
                progressText.textContent = 'Processing: 100%';
                
                // Save the merged PDF
                const mergedPdfBytes = await mergedPdf.save();
                
                // Convert to blob and create object URL
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                
                // Revoke previous URL if it exists
                if (currentPdfUrl) {
                    URL.revokeObjectURL(currentPdfUrl);
                }
                
                // Create new URL for the PDF
                currentPdfUrl = URL.createObjectURL(blob);
                
                // Replace the download button entirely to remove any previous event listeners
                const buttonContainer = document.getElementById('shareButtons');
                const oldDownloadBtn = document.getElementById('downloadBtn');
                
                // Create a completely new download button
                const newDownloadBtn = document.createElement('a');
                newDownloadBtn.id = 'downloadBtn';
                newDownloadBtn.href = currentPdfUrl;
                newDownloadBtn.setAttribute('download', `combined_${new Date().toISOString().slice(0, 10)}.pdf`);
                newDownloadBtn.className = 'inline-flex items-center justify-center rounded-full border border-transparent bg-primary px-6 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-white';
                newDownloadBtn.textContent = 'Download PDF';
                
                // Replace the old button with the new one
                buttonContainer.replaceChild(newDownloadBtn, oldDownloadBtn);
                
                // Display the PDF using PDF.js
                renderPdf(currentPdfUrl);
                resultContainer.classList.remove('hidden');
                
                // Hide progress after a delay
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error('Error combining PDFs:', error);
                alert('An error occurred while combining PDFs. Please try again.');
                progressContainer.classList.add('hidden');
            }
        }

        // Read file as ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Render PDF using PDF.js
        async function renderPdf(url) {
            try {
                const pdfCanvasContainer = document.getElementById('pdfCanvasContainer');
                
                // Clear previous content
                pdfCanvasContainer.innerHTML = '';
                
                // Create a new loading indicator
                const loadingText = document.createElement('p');
                loadingText.id = 'loadingText';
                loadingText.className = 'flex items-center gap-2 font-mono text-sm uppercase tracking-[0.3em] text-black/60 dark:text-white/60';
                loadingText.innerHTML = `
                    <span class="text-lg">⌁</span>
                    Loading PDF...
                `;
                pdfCanvasContainer.appendChild(loadingText);
                
                // Load the PDF
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                
                // Remove loading indicator
                pdfCanvasContainer.removeChild(loadingText);
                
                // Get total number of pages
                const numPages = pdf.numPages;
                
                // Set scale based on viewer width
                const viewerWidth = document.getElementById('pdfViewer').clientWidth - 40; // Subtract padding
                const scale = 1.0;
                
                // Render each page
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    // Create page container
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'w-full space-y-2';
                    
                    // Create page number indicator
                    const pageIndicator = document.createElement('div');
                    pageIndicator.className = 'font-mono text-[0.7rem] uppercase tracking-[0.3em] text-black/60 dark:text-white/60 text-center';
                    pageIndicator.textContent = `Page ${pageNum} of ${numPages}`;
                    pageContainer.appendChild(pageIndicator);
                    
                    // Create canvas for the page
                    const canvas = document.createElement('canvas');
                    canvas.className = 'w-full rounded-2xl border border-black/10 bg-white dark:border-white/15 dark:bg-[#111922]';
                    pageContainer.appendChild(canvas);
                    
                    // Get the page
                    const page = await pdf.getPage(pageNum);
                    
                    // Get viewport
                    const viewport = page.getViewport({ scale });
                    
                    // Calculate scale to fit width
                    const widthScale = viewerWidth / viewport.width;
                    const scaledViewport = page.getViewport({ scale: widthScale });
                    
                    // Set canvas dimensions
                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;
                    
                    // Render the page
                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: scaledViewport
                    };
                    
                    await page.render(renderContext).promise;
                    pdfCanvasContainer.appendChild(pageContainer);
                }
                
                // Scroll to top
                document.getElementById('pdfViewer').scrollTop = 0;
                
            } catch (error) {
                console.error('Error rendering PDF:', error);
                const pdfCanvasContainer = document.getElementById('pdfCanvasContainer');
                pdfCanvasContainer.innerHTML = `
                    <div class="py-8 text-center text-red-500">
                        <p>Error loading PDF. Please try again.</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Add these new event listeners after the existing ones
        const dropZone = document.getElementById('dropZone');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop zone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        function preventDefaults (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropZone.style.borderColor = '#F25F4C';
            dropZone.style.backgroundColor = 'rgba(242, 95, 76, 0.1)';
        }

        function unhighlight() {
            dropZone.style.borderColor = '';
            dropZone.style.backgroundColor = '';
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            // Create a new FileList-like object
            const fileInput = document.getElementById('fileInput');
            fileInput.files = files;
            
            // Trigger the file selection handler
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }
    </script>
</body>
</html>
